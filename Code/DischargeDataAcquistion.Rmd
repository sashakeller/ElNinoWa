---
title: "Discharge Data"
author: "Sasha Keller"
date: "4/12/2022"
output: pdf_document
---

```{r}
# Set your working directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# Set Output options
knitr::opts_chunk$set(echo=FALSE)

# Load your packages
library(EcoHydRology)
library(tidyverse)
library(cowplot)
library(dataRetrieval)
library(lubridate)
library(lfstat)
library(trend)
# Set your ggplot theme
theme_set(theme_classic())
# Load your datasets

```
```{r, process ENSO data}
enso<-read_csv("Data/Raw/monthly_enso.csv")
enso$Months<-as.Date(enso$Months, form="%y/%m/%d")
enso_processed<-enso%>%
  mutate(Year = year(Months),
         Month = month(Months))%>%
  group_by(Year, Month) %>%
  mutate(season.class=case_when(SST>0.5 ~ "El Niño",
                                SST< -0.5 ~ "La Niña",
                                TRUE~"Neutral"))
```

```{r} 
#Tulalip
TulalipDischarge <- readNWISdv(siteNumbers = "12158040",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")
names(TulalipDischarge)[4:5] <- c("Discharge", "Approval.Code")
attr(TulalipDischarge, "variableInfo")
attr(TulalipDischarge, "siteInfo")

TulalipProccessed <- TulalipDischarge %>%
  mutate(Baseflow = baseflow(Discharge), 
         Stormflow = Discharge - Baseflow,
         Year = year(Date), 
         Year = year(Date),
         Month = month(Date),
         Discharge_acftmo = sum(Discharge)*1.98347)
TulalipENSO<-TulalipProccessed%>%
    filter(Year>1999)%>%
  left_join(enso_processed)

#Skokomish
SkokomishDischarge <- readNWISdv(siteNumbers = "12061500",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

names(SkokomishDischarge)[4:5] <- c("Discharge", "Approval.Code")
attr(SkokomishDischarge, "variableInfo")
attr(SkokomishDischarge, "siteInfo")

SkokomishProccessed <- SkokomishDischarge %>%
  mutate(Baseflow = baseflow(Discharge), 
         Stormflow = Discharge - Baseflow,
         Year = year(Date), 
         Year = year(Date),
         Month = month(Date),
         Discharge_acftmo = sum(Discharge)*1.98347)
SkokomishENSO<-SkokomishProccessed%>%
  filter(Year>1999)%>%
  left_join(enso_processed)

#Duckabush
DuckabushDischarge <- readNWISdv(siteNumbers = "12054000",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")
names(DuckabushDischarge)[4:5] <- c("Discharge", "Approval.Code")
attr(DuckabushDischarge, "variableInfo")
attr(DuckabushDischarge, "siteInfo")

DuckProccessed <- DuckabushDischarge %>%
  mutate(Baseflow = baseflow(Discharge), 
         Stormflow = Discharge - Baseflow,
         Year = year(Date), 
         Year = year(Date),
         Month = month(Date))

DuckMonthly<- DuckProccessed%>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

DuckabushENSO<-DuckProccessed%>%
    filter(Year>1999)%>%
  left_join(enso_processed)%>%
  left_join(DuckMonthly)

#Puyallup
PuyallupDischarge <- readNWISdv(siteNumbers = "12101500",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

names(PuyallupDischarge)[4:5] <- c("Discharge", "Approval.Code")
attr(PuyallupDischarge, "variableInfo")
attr(PuyallupDischarge, "siteInfo")

PuyallupProccessed <- PuyallupDischarge %>%
  mutate(Baseflow = baseflow(Discharge), 
         Stormflow = Discharge - Baseflow,
         Year = year(Date), 
         Year = year(Date),
         Month = month(Date),
         Discharge_acftmo = sum(Discharge)*1.98347)
PuyallupENSO<-PuyallupProccessed%>%
    filter(Year>1999)%>%
  left_join(enso_processed)
  

  
ggplot(PuyallupENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point() +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Puyallup Daily Discharge")

ggplot(TulalipENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point() +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Tulalip Daily Discharge")

ggplot(SkokomishENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point() +
  geom_smooth()+
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Skokomish Daily Discharge")


```



```{r, Duckabush}
#Climate events will be identified using NOAA's Climate Prediction Center (https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php).
#El Nino events should create a warmer, drier climate in Washington while La Nina will create a cooler, wetter environment. 


DuckLa<- DuckabushENSO %>%
  filter(season.class%in% c("La Niña",  "Neutral"))
DuckEl<-DuckabushENSO %>%
  filter(season.class%in% c("Neutral",  "El Niño"))
DuckEx<-DuckabushENSO %>%
  filter(season.class %in% c("La Niña",  "El Niño"))


#Is there  a significant difference in monthly discharges between season classes?
kruskal.test(Discharge_acftmo ~ season.class, data = DuckabushENSO)
#Are the classes distinct?
kruskal.test(Discharge_acftmo ~ season.class, data=DuckabushENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckEx)

ggplot(DuckabushENSO, aes(x=Year,y=Discharge_acftmo, color=season.class))+
  geom_point(size=4) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  scale_y_log10()+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Monthly Discharge")



#How about daily discharge?
kruskal.test(Discharge ~ season.class, data = DuckabushENSO)
#Are the classes distinct?
kruskal.test(Discharge ~ season.class, data=DuckabushENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge ~ season.class, data=DuckEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge ~ season.class, data=DuckLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge ~ season.class, data=DuckEx)

ggplot(DuckabushENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point(alpha=0.7) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Daily Discharge")

 #What about during the largest precipitation events?
DuckStormKT<-kruskal.test(Stormflow ~ season.class, data=DuckabushENSO)
#Is stormflow different between Neutral and El Nino?
DuckStormWEl<-wilcox.test(Stormflow ~ season.class, data=DuckEl)
#Is stormflow different between Neutral and La Nina?
DuckStormWLa<-wilcox.test(Stormflow ~ season.class, data=DuckLa)
#Is stormflow different between La Nina and El Nino?
DuckStormWEx<-wilcox.test(Stormflow ~ season.class, data=DuckEx)
```

```{r, Puyallup}

PuyallupLa<- PuyallupENSO %>%
  filter(season.class%in% c("La Niña",  "Neutral"))
PuyallupEl<-PuyallupENSO %>%
  filter(season.class%in% c("Neutral",  "El Niño"))
PuyallupEx<-PuyallupENSO %>%
  filter(season.class %in% c("La Niña",  "El Niño"))


#Is there  a significant difference in monthly discharges between season classes?
kruskal.test(Discharge_acftmo ~ season.class, data = PuyallupENSO)
#Are the classes distinct?
kruskal.test(Discharge_acftmo ~ season.class, data=PuyallupENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=PuyallupEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge_acftmo ~ season.class, data=PuyallupLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=PuyallupEx)

ggplot(PuyallupENSO, aes(x=Year,y=Discharge_acftmo, color=season.class))+
  geom_point(size=4) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  scale_y_log10()+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Monthly Discharge")



#How about daily discharge?
kruskal.test(Discharge ~ season.class, data = PuyallupENSO)
#Are the classes distinct?
kruskal.test(Discharge ~ season.class, data=PuyallupENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge ~ season.class, data=PuyallupEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge ~ season.class, data=PuyallupLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge ~ season.class, data=PuyallupEx)

ggplot(PuyallupENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point(alpha=0.7) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Daily Discharge")

 #What about during the largest precipitation events?
PuyallupStormKT<-kruskal.test(Stormflow ~ season.class, data=PuyallupENSO)
#Is stormflow different between Neutral and El Nino?
PuyallupStormWEl<-wilcox.test(Stormflow ~ season.class, data=PuyallupEl)
#Is stormflow different between Neutral and La Nina?
PuyallupStormWLa<-wilcox.test(Stormflow ~ season.class, data=PuyallupLa)
#Is stormflow different between La Nina and El Nino?
PuyallupStormWEx<-wilcox.test(Stormflow ~ season.class, data=PuyallupEx)


```

```{r, Skokomish}


SkokomishLa<- SkokomishENSO %>%
  filter(season.class%in% c("La Niña",  "Neutral"))
SkokomishEl<-SkokomishENSO %>%
  filter(season.class%in% c("Neutral",  "El Niño"))
SkokomishEx<-SkokomishENSO %>%
  filter(season.class %in% c("La Niña",  "El Niño"))


#Is there  a significant difference in monthly discharges between season classes?
kruskal.test(Discharge_acftmo ~ season.class, data = SkokomishENSO)
#Are the classes distinct?
kruskal.test(Discharge_acftmo ~ season.class, data=SkokomishENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=SkokomishEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge_acftmo ~ season.class, data=SkokomishLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=SkokomishEx)

ggplot(SkokomishENSO, aes(x=Year,y=Discharge_acftmo, color=season.class))+
  geom_point(size=4) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  scale_y_log10()+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Monthly Discharge")



#How about daily discharge?
kruskal.test(Discharge ~ season.class, data = SkokomishENSO) 
#Are the classes distinct?
kruskal.test(Discharge ~ season.class, data=SkokomishENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge ~ season.class, data=SkokomishEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge ~ season.class, data=SkokomishLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge ~ season.class, data=SkokomishEx)

ggplot(SkokomishENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point(alpha=0.7) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Daily Discharge")

 #What about during the largest precipitation events?
SkokomishStormKT<-kruskal.test(Stormflow ~ season.class, data=SkokomishENSO)
#Is stormflow different between Neutral and El Nino?
SkokomishStormWEl<-wilcox.test(Stormflow ~ season.class, data=SkokomishEl)
#Is stormflow different between Neutral and La Nina?
SkokomishStormWLa<-wilcox.test(Stormflow ~ season.class, data=SkokomishLa)
#Is stormflow different between La Nina and El Nino?
SkokomishStormWEx<-wilcox.test(Stormflow ~ season.class, data=SkokomishEx)
```

```{r, Tulalip}
TulalipLa<- TulalipENSO %>%
  filter(season.class%in% c("La Niña",  "Neutral"))
TulalipEl<-TulalipENSO %>%
  filter(season.class%in% c("Neutral",  "El Niño"))
TulalipEx<-TulalipENSO %>%
  filter(season.class %in% c("La Niña",  "El Niño"))


#Is there  a significant difference in monthly discharges between season classes?
kruskal.test(Discharge_acftmo ~ season.class, data = TulalipENSO)
#Are the classes distinct?
kruskal.test(Discharge_acftmo ~ season.class, data=TulalipENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=TulalipEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge_acftmo ~ season.class, data=TulalipLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=TulalipEx)

ggplot(TulalipENSO, aes(x=Year,y=Discharge_acftmo, color=season.class))+
  geom_point(size=4) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  scale_y_log10()+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Monthly Discharge")



#How about daily discharge?
kruskal.test(Discharge ~ season.class, data = TulalipENSO)
#Are the classes distinct?
kruskal.test(Discharge ~ season.class, data=TulalipENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge ~ season.class, data=TulalipEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge ~ season.class, data=TulalipLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge ~ season.class, data=TulalipEx)

ggplot(TulalipENSO, aes(x = Date, y = Discharge, color=season.class)) +
  geom_point(alpha=0.7) +
    scale_color_manual(values = c("El Niño"="#feb24c",
                                  "La Niña"="#2c7fb8",
                                  "Neutral"="#7fcdbb"))+
  labs(x = "Year", y = "Discharge (cfs)")+
  ggtitle("Duckabush Daily Discharge")

 #What about during the largest precipitation events?
TulalipStormKT<-kruskal.test(Stormflow ~ season.class, data=TulalipENSO)
#Is stormflow different between Neutral and El Nino?
TulalipStormWEl<-wilcox.test(Stormflow ~ season.class, data=TulalipEl)
#Is stormflow different between Neutral and La Nina?
TulalipStormWLa<-wilcox.test(Stormflow ~ season.class, data=TulalipLa)
#Is stormflow different between La Nina and El Nino?
TulalipStormWEx<-wilcox.test(Stormflow ~ season.class, data=TulalipEx)


```

Questions: 
Is 3 month seasonal mean common water format or just climate data?


Causes for changes in discharge?
el nino la nina working as intended
el nino la nina 



How to identify relevant baseflow with so many ~*events*~ happening?




What is proper to compare?
code la nina, el nino, neither times to the data set then do summary stats to investigate? t test?


SMK t test for artifical seasons? 
Can I just recode El Nino/La Nina/Neither as 1,2,3 and run a t test frequency = 3?




#TO DO
- Put stat tests into variables, put variables into table
- Make a smaller time frame discharge plot to show variance in season?
- Put all ggplots together somehow
- save datasets as objects, so I can put the plot code in another file
- Finish write up






