---
title: "Discharge Data"
author: "Sasha Keller"
date: "4/12/2022"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
#opts_knit$set(root.dir = "~/Duke/2021_2022/Spring/WaterDataAnalytics/ElNinoWa/ElNinoWa")
#setwd("~/Duke/2021_2022/Spring/WaterDataAnalytics/ElNinoWa/ElNinoWa")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
# Set your working directory

# Load your packages
library(EcoHydRology)
library(tidyverse)
library(cowplot)
library(dataRetrieval)
library(lubridate)
library(lfstat)
library(trend)
# Set your ggplot theme
theme_set(theme_dark())
# Load your datasets

```

```{r}

DuckabushDischarge <- readNWISdv(siteNumbers = "12054000",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

PuyallupDischarge <- readNWISdv(siteNumbers = "12101500",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

names(DuckabushDischarge)[4:5] <- c("Discharge", "Approval.Code")
names(PuyallupDischarge)[4:5] <- c("Discharge", "Approval.Code")

attr(DuckabushDischarge, "variableInfo")
attr(DuckabushDischarge, "siteInfo")
  
ggplot(DuckabushDischarge, aes(x = Date, y = Discharge)) +
  geom_line() +
  labs(x = "Year", y = "Discharge (cfs)")
  
attr(PuyallupDischarge, "variableInfo")
attr(PuyallupDischarge, "siteInfo")
  
ggplot(PuyallupDischarge, aes(x = Date, y = Discharge)) +
  geom_line() +
  labs(x = "Year", y = "Discharge (cfs)")

```
```{r}
#Climate events will be identified using NOAA's Climate Prediction Center (https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php).
#El Nino events should create a warmer, drier climate in Washington while La Nina will create a cooler, wetter environment. 


DuckabushDischarge <- DuckabushDischarge %>%
  mutate(Baseflow_lfstat = baseflow(Discharge), 
         Stormflow_lfstat = Discharge - Baseflow_lfstat,
         Year = year(Date), 
         WaterYear = water_year(Date))
DuckabushDischarge$WaterYear <- as.numeric(as.character(DuckabushDischarge$WaterYear))


PuyallupDischarge <- PuyallupDischarge %>%
  mutate(Baseflow_lfstat = baseflow(Discharge), 
         Stormflow_lfstat = Discharge - Baseflow_lfstat,
         Year = year(Date), 
         WaterYear = water_year(Date))
PuyallupDischarge$WaterYear <- as.numeric(as.character(PuyallupDischarge$WaterYear))
```

```{r}
enso<-read_csv("Data/Raw/monthly_enso.csv")
enso$Months<-as.Date(enso$Months, form="%y/%m/%d")
enso_processed<-enso%>%
  mutate(Year = year(Months),
         Month = month(Months))%>%
  group_by(Year, Month)

# generate total monthly discharge
Duckabush_proccessed_monthly <- DuckabushDischarge %>%
  mutate(Year = year(Date),
         Month = month(Date)) %>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

DuckabushDisSST<-left_join(Duckabush_proccessed_monthly, enso_processed)
DuckabushENSO<- DuckabushDisSST %>%
  select(Month, Year, Discharge_acftmo, SST)%>%
  filter(Year>1999) %>%
  mutate(season.class=case_when(SST>0.5 ~ "El_Nino",
                                SST< -0.5 ~ "La_Nina",
                                TRUE~"Neutral"))

DuckEl<- DuckabushENSO %>%
  filter(season.class=="El_Nino")
DuckLa<- DuckabushENSO %>%
  filter(season.class=="La_Nina")
DuckNeu<-DuckabushENSO %>%
  filter(season.class=="Neutral")

# generate total monthly discharge
Puyallup_proccessed_monthly <- PuyallupDischarge %>%
  mutate(Year = year(Date),
         Month = month(Date)) %>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

PuyallupDisSST<-left_join(Puyallup_proccessed_monthly, enso_processed)
PuyallupENSO<- PuyallupDisSST %>%
  select(Month, Year, Discharge_acftmo, SST)%>%
  filter(Year>1999) %>%
  mutate(season.class=case_when(SST>0.5 ~ "El_Nino",
                                SST< -0.5 ~ "La_Nina",
                                TRUE~"Neutral"))

PuyallupEl<- DuckabushENSO %>%
  filter(season.class=="El_Nino")
PuyallupLa<- DuckabushENSO %>%
  filter(season.class=="La_Nina")
PuyallupNeu<-DuckabushENSO %>%
  filter(season.class=="Neutral")


kruskal.test(Discharge_acftmo ~ season.class, data = DuckabushENSO)
kruskal.test(Discharge_acftmo ~ season.class, data = PuyallupENSO)

```

```{r, el nino/la nina classes}


DuckabushDischarge <- DuckabushDischarge %>%
  mutate(season.class = case_when(Date> "2002-4-30" & Date<"2003-4-1"
                                  | Date>"2004-5-31" & Date<"2005-4-1"
                                  | Date>"2006-7-31" & Date<"2007-3-1"
                                  | Date>"2009-5-31" & Date<"2010-5-1"
                                  | Date> "2014-8-30" & Date<"2016-6-1"
                                  | Date>"2018-7-31" & Date<"2019-8-1" ~ "El_Nino",
                                  Date> "2005-9-30" & Date<"2006-5-1"
                                  | Date>"2004-5-31" & Date<"2005-4-1"
                                  | Date>"2007-4-30" & Date<"2008-8-1"
                                  | Date>"2008-9-30" & Date<"2009-5-1"
                                  | Date> "2010-4-30" & Date<"2012-6-1"
                                  | Date> "2016-6-30" & Date<"2017-2-1"
                                  | Date> "2017-8-30" & Date<"2018-6-1"
                                  | Date> "2020-6-30" & Date<"2022-4-1" ~ "La_Nina",
                                  TRUE ~ "Neutral"
                                  ))

# create a data frame of months
Months <- data.frame(Date_monthrounded = seq.Date(from = as.Date("2000-10-01"), to = as.Date("2022-4-01"), by = "month"))


# generate total monthly discharge
Duckabush_proccessed_monthly <- DuckabushDischarge %>%
  mutate(Year = year(Date),
         Month = month(Date)) %>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

Duckabush_timeseries <- ts(Duckabush_proccessed_monthly$Discharge_acftmo, frequency = 12,
                           start = c(2000, 1, 1), end = c(2022, 4, 1))

Duckabush_trend<- smk.test(Duckabush_timeseries)

Duckabush_trend
summary(Duckabush_trend)
```


END1<- DuckabushDischarge %>%
  filter(Date> "2014-8-30" & Date<"2016-6-1")
ENP1<-PuyallupDischarge %>%
  filter(Date> "2014-8-30" & Date<"2016-6-1")

LND1<- DuckabushDischarge %>%
  filter(Date> "2010-4-30" & Date<"2012-6-1")
LNP1<-PuyallupDischarge %>%
  filter(Date> "2010-4-30" & Date<"2012-6-1")

ggplot(DuckabushDischarge, aes(x=Date, y=Discharge))+
  geom_line()


ggplot(END1, aes(x=Date,y=Discharge))+
  geom_line(color="white")+
  geom_line(aes(y=Baseflow_lfstat))


ggplot(LND1, aes(x=Date,y=Discharge))+
  geom_line(color="white")+
  geom_line(aes(y=Baseflow_lfstat))


Questions: 
Is 3 month seasonal mean common water format or just climate data?


Causes for changes in discharge?
el nino la nina working as intended
el nino la nina 



How to identify relevant baseflow with so many ~*events*~ happening?




What is proper to compare?
code la nina, el nino, neither times to the data set then do summary stats to investigate? t test?


SMK t test for artifical seasons? 
Can I just recode El Nino/La Nina/Neither as 1,2,3 and run a t test frequency = 3?









