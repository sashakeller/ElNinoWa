---
title: "Discharge Data"
author: "Sasha Keller"
date: "4/12/2022"
output: pdf_document
---

```{r}
# Set your working directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# Load your packages
library(EcoHydRology)
library(tidyverse)
library(cowplot)
library(dataRetrieval)
library(lubridate)
library(lfstat)
library(trend)
# Set your ggplot theme
theme_set(theme_dark())
# Load your datasets

```

```{r} 
TulalipDischarge <- readNWISdv(siteNumbers = "12158040",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

SkokomishDischarge <- readNWISdv(siteNumbers = "12061500",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")


DuckabushDischarge <- readNWISdv(siteNumbers = "12054000",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

PuyallupDischarge <- readNWISdv(siteNumbers = "12101500",
                     parameterCd = "00060", # discharge (ft3/s)
                     startDate = "1974-10-01", 
                     endDate = "2021-09-30")

names(DuckabushDischarge)[4:5] <- c("Discharge", "Approval.Code")
names(PuyallupDischarge)[4:5] <- c("Discharge", "Approval.Code")

attr(DuckabushDischarge, "variableInfo")
attr(DuckabushDischarge, "siteInfo")
  
ggplot(DuckabushDischarge, aes(x = Date, y = Discharge)) +
  geom_line() +
  labs(x = "Year", y = "Discharge (cfs)")
  
attr(PuyallupDischarge, "variableInfo")
attr(PuyallupDischarge, "siteInfo")
  
ggplot(PuyallupDischarge, aes(x = Date, y = Discharge)) +
  geom_line() +
  labs(x = "Year", y = "Discharge (cfs)")

```

```{r, process ENSO data}
enso<-read_csv("Data/Raw/monthly_enso.csv")
enso$Months<-as.Date(enso$Months, form="%y/%m/%d")
enso_processed<-enso%>%
  mutate(Year = year(Months),
         Month = month(Months))%>%
  group_by(Year, Month) %>%
  mutate(season.class=case_when(SST>0.5 ~ "El_Nino",
                                SST< -0.5 ~ "La_Nina",
                                TRUE~"Neutral"))
```

```{r}
#Climate events will be identified using NOAA's Climate Prediction Center (https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php).
#El Nino events should create a warmer, drier climate in Washington while La Nina will create a cooler, wetter environment. 


DuckProccessed <- DuckabushDischarge %>%
  mutate(Baseflow = baseflow(Discharge), 
         Stormflow = Discharge - Baseflow,
         Year = year(Date), 
         WaterYear = water_year(Date),
         Year = year(Date),
         Month = month(Date),
         Discharge_acftmo = sum(Discharge)*1.98347)#%>%
  #group_by(Year, Month) %>%
  #summarise(Discharge_acftmo = sum(Discharge)*1.98347)
DuckabushDischarge$WaterYear <- as.numeric(as.character(DuckabushDischarge$WaterYear))

# generate total monthly discharge
Duckabush_proccessed_monthly <- DuckabushDischarge %>%
  group_by(Year, Month,Date)%>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

DuckabushDisSST<-left_join(Duckabush_proccessed_monthly, enso_processed)
DuckabushENSO<- DuckabushDisSST %>%
  select(Date,Month, Year, Discharge_acftmo, SST, season.class)%>%
  filter(Year>1999)


DuckLa<- DuckabushENSO %>%
  filter(season.class%in% c("La_Nina",  "Neutral"))
DuckEl<-DuckabushENSO %>%
  filter(season.class%in% c("Neutral",  "El_Nino"))
DuckEx<-DuckabushENSO %>%
  filter(season.class %in% c("La_Nina",  "El_Nino"))

kruskal.test(Discharge_acftmo ~ season.class, data = DuckabushENSO)
kruskal.test(Discharge_acftmo ~ season.class, data=DuckEx)
#Are the classes distinct?
kruskal.test(Discharge_acftmo ~ season.class, data=DuckabushENSO)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge_acftmo ~ season.class, data=DuckEx)

ggplot(DuckabushENSO, aes(x=Date,y=Discharge_acftmo, color=season.class))+
  geom_line(aes(y=Discharge_acftmo))
```

```{r}
DuckENSO<-left_join(DuckabushDischarge, enso_processed)
DuckENSODisTest<- DuckENSO %>%
  select(Date,Month, Year, Discharge, season.class)%>%
  filter(Year>1999)

DuckLa<- DuckENSODis %>%
  filter(season.class%in% c("La_Nina",  "Neutral"))
DuckEl<-DuckENSODis %>%
  filter(season.class%in% c("Neutral",  "El_Nino"))
DuckEx<-DuckENSODis %>%
  filter(season.class %in% c("La_Nina",  "El_Nino"))

kruskal.test(Discharge ~ season.class, data = DuckENSODis)
kruskal.test(Discharge ~ season.class, data=DuckEx)
#Are the classes distinct?
kruskal.test(Discharge ~ season.class, data=DuckENSODis)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Discharge ~ season.class, data=DuckEl)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Discharge ~ season.class, data=DuckLa)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Discharge ~ season.class, data=DuckEx)

ggplot(DuckENSODis, aes(x=Date,y=Discharge, color=season.class))+
  geom_line(aes(y=Discharge))
```

```{r}

PuyallupDischarge <- PuyallupDischarge %>%
  mutate(Baseflow_lfstat = baseflow(Discharge), 
         Stormflow_lfstat = Discharge - Baseflow_lfstat,
         Year = year(Date), 
         WaterYear = water_year(Date),
         Year = year(Date),
         Month = month(Date))%>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)
PuyallupDischarge$WaterYear <- as.numeric(as.character(PuyallupDischarge$WaterYear))

# generate total monthly discharge
Puyallup_proccessed_monthly <- PuyallupDischarge %>%
  group_by(Year, Month) %>%
  summarise(Discharge_acftmo = sum(Discharge)*1.98347)

PuyallupDisSST<-left_join(Puyallup_proccessed_monthly, enso_processed)
PuyallupENSO<- PuyallupDisSST %>%
  select(Month, Year, Discharge_acftmo, SST,season.class)%>%
  filter(Year>1999)

PuyallupEl<- PuyallupENSO %>%
  filter(season.class=="El_Nino")
PuyallupLa<- PuyallupENSO %>%
  filter(season.class=="La_Nina")
PuyallupEx<-PuyallupENSO %>%
  filter(season.class %in% c("La_Nina",  "El_Nino"))
PuyallupNeu<-PuyallupENSO %>%
  filter(season.class=="Neutral")

kruskal.test(Discharge_acftmo ~ season.class, data = PuyallupENSO)
kruskal.test(Discharge_acftmo ~ season.class, data=PuyallupEx)



```

```{r, stormflow}


ggplot(DuckabushDischarge, aes(x=Date, y=Baseflow))+
  geom_line(aes(y=Stormflow), color="white")+
  geom_line(aes(y=Baseflow))

DuckabushStorm<- DuckProccessed %>%
  left_join(enso_processed)%>%
  filter(Year>1999)%>%
  select(Date,Stormflow,season.class)

DSEN<-DuckabushStorm%>%
  filter(season.class %in% c("El_Nino","Neutral"))
DSLN<-DuckabushStorm%>%
  filter(season.class %in% c("La_Nina","Neutral"))
DSEL<-DuckabushStorm%>%
  filter(season.class %in% c("La_Nina","El_Nino"))

#Are the classes distinct?
kruskal.test(Stormflow ~ season.class, data=DuckabushStorm)
#Is stormflow different between Neutral and El Nino?
wilcox.test(Stormflow ~ season.class, data=DSEN)
#Is stormflow different between Neutral and La Nina?
wilcox.test(Stormflow ~ season.class, data=DSEN)
#Is stormflow different between La Nina and El Nino?
wilcox.test(Stormflow ~ season.class, data=DSEL)
```

Questions: 
Is 3 month seasonal mean common water format or just climate data?


Causes for changes in discharge?
el nino la nina working as intended
el nino la nina 



How to identify relevant baseflow with so many ~*events*~ happening?




What is proper to compare?
code la nina, el nino, neither times to the data set then do summary stats to investigate? t test?


SMK t test for artifical seasons? 
Can I just recode El Nino/La Nina/Neither as 1,2,3 and run a t test frequency = 3?









